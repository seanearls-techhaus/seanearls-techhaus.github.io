<!DOCTYPE html>
<html>
<head>
    <title>Site 1 - Page 2</title>

    <script type="text/javascript">

        // Function to get the value of a cookie
        function getCookie(name) {
            var value = "; " + document.cookie;
            var parts = value.split("; " + name + "=");
            if (parts.length === 2) {
                return parts.pop().split(";").shift();
            }
            return "";
        }
    </script>

    <script type="text/javascript">
        !function(){if(!window.klaviyo){window._klOnsite=window._klOnsite||[];try{window.klaviyo=new Proxy({},{get:function(n,i){return"push"===i?function(){var n;(n=window._klOnsite).push.apply(n,arguments)}:function(){for(var n=arguments.length,o=new Array(n),w=0;w<n;w++)o[w]=arguments[w];var t="function"==typeof o[o.length-1]?o.pop():void 0,e=new Promise((function(n){window._klOnsite.push([i].concat(o,[function(i){t&&t(i),n(i)}]))}));return e}}})}catch(n){window.klaviyo=window.klaviyo||[],window.klaviyo.push=function(){var n;(n=window._klOnsite).push.apply(n,arguments)}}}}();
    </script>

    <script type="text/javascript" src="//static.klaviyo.com/onsite/js/klaviyo.js?company_id=SEPBCg" async></script>

    <script type="text/javascript">

        function getKlaviyoCookie() {
            var name = "_kx=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) === 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        var klaviyoCookie = getKlaviyoCookie();
        console.log(klaviyoCookie);


        const options = {
            method: 'POST',
            headers: {'accept': 'application/json', 'content-type': 'application/json'},
            body: JSON.stringify({exchange_id: 'EXCHANGE_ID'})
        };

        fetch('https://a.klaviyo.com/api/v2/people/exchange?api_key=SEBPg', options)
            .then(response => response.json())
            .then(response => console.log(response))
            .catch(err => console.error(err));
    </script>

    <!-- Klaviyo tracking code -->
    <script type="text/javascript">
        window.addEventListener("load", function() {
            // Get the email from the cookie
            var email = getCookie('userEmailKla');
            console.log("Email: ", getCookie('userEmailKla'));

            // Include Klaviyo's JavaScript SDK
            var klaviyo = window.klaviyo || [];
            klaviyo.push(['publicApiKey', 'SEPBCg']);
            console.log("ggggg");
            console.log(klaviyo.isIdentified());

            var pageUrl = window.location.href;

            // Define some dummy metadata
            var metadata = {
                page_url: pageUrl
            };
            console.log("email: " + email);

            // Identify a user
            klaviyo.push(['identify', {
                '$email' : email, // the user's email
            }]);

            // Track an event with Klaviyo
            klaviyo.push(['track', 'User Page Tracking', metadata]);
        });
    </script>
</head>
<body>
    <h1>Site 1 - Page 2</h1>
    
    <button onclick="location.href='https://seanearls.github.io/index.html'" type="button">
        Go to Site 2 - Page 1
    </button> 

    
</body>
</html>

